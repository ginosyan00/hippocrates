// Hippocrates Dental - Database Schema
// Provider: SQLite (для MVP)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// CLINIC (Клиника)
// ============================================

model Clinic {
  id            String    @id @default(uuid())
  name          String
  slug          String    @unique
  email         String
  phone         String
  address       String?
  city          String
  about         String?
  logo          String?
  workingHours  String?   // JSON as String in SQLite
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  users         User[]
  patients      Patient[]
  appointments  Appointment[]

  @@map("clinics")
}

// ============================================
// USER (Multi-Role: Patient, Doctor, Partner, Admin)
// ============================================

// Note: SQLite doesn't support enums, so we use String with validation in code
// Valid roles: "PATIENT" | "DOCTOR" | "PARTNER" | "ADMIN"
// Valid statuses: "PENDING" | "ACTIVE" | "SUSPENDED" | "REJECTED"

model User {
  id             String      @id @default(uuid())
  clinicId       String?     // Optional - только для Doctor/Admin
  name           String
  email          String      @unique
  passwordHash   String
  role           String      @default("PATIENT")    // PATIENT | DOCTOR | PARTNER | ADMIN
  status         String      @default("ACTIVE")     // PENDING | ACTIVE | SUSPENDED | REJECTED
  
  // Common fields
  phone          String?
  avatar         String?
  dateOfBirth    DateTime?
  gender         String?     // male | female | other
  
  // Doctor-specific fields
  specialization String?     // Только для DOCTOR
  licenseNumber  String?     // Номер лицензии
  experience     Int?        // Опыт работы (лет)
  
  // Partner-specific fields
  organizationName String?   // Название организации
  organizationType String?   // pharmacy | laboratory | insurance
  inn              String?   // ИНН/ОГРН
  address          String?   // Адрес организации
  
  // System fields
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  clinic         Clinic?     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  appointments   Appointment[]

  @@index([clinicId])
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

// ============================================
// PATIENT (Пациент)
// ============================================

model Patient {
  id           String    @id @default(uuid())
  clinicId     String
  name         String
  phone        String
  email        String?
  dateOfBirth  DateTime?
  gender       String?  // male | female | other
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  clinic       Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@index([clinicId])
  @@index([phone])
  @@map("patients")
}

// ============================================
// APPOINTMENT (Приём)
// ============================================

model Appointment {
  id              String    @id @default(uuid())
  clinicId        String
  doctorId        String
  patientId       String
  appointmentDate DateTime
  duration        Int       @default(30)
  status          String  @default("pending")  // pending | confirmed | completed | cancelled
  notes           String?
  reason          String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  clinic          Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  doctor          User      @relation(fields: [doctorId], references: [id])
  patient         Patient   @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([doctorId])
  @@index([patientId])
  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

